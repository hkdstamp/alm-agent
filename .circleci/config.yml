---
version: 2
jobs:
  build:
    working_directory: /go/src/github.com/mobingilabs/go-modaemon
    docker:
      - image: golang:1.8.1
    steps:
      - checkout
      - restore_cache:
          key: godeps-{{ .Branch }}-{{ checksum "Gopkg.lock" }}
      - run:
          name: test and build maincli
          command: make cibuild
      - run:
          name: build addons
          command: make addon
      - save_cache:
          key: godeps-{{ .Branch }}-{{ checksum "Gopkg.lock" }}
          paths:
            - "/go/src"
      - store_artifacts:
          path: bin/
          destination: bin
      - persist_to_workspace:
          root: .
          paths:
            - bin
            - .circleci

  deploy:
    docker:
      - image: alpine:3.6
    working_directory: /tmp/workspace
    steps:
      - run:
          name: install deps
          command: |
            apk add --update groff less python bash curl jq tar
            wget "s3.amazonaws.com/aws-cli/awscli-bundle.zip" -O "awscli-bundle.zip"
            unzip awscli-bundle.zip
            ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: create archive
          command: tar cvzf bin/go-modaemon.tgz bin/*
      - run:
          name: put release infomation
          command: |
            pwd
            find `pwd`
    #   - run:
    #       name: put release infomation
    #       command: ${CIRCLE_WORKING_DIRECTORY}/bin/go-modaemon -v > ${CIRCLE_BRANCH}.json
    #   - run:
    #       name: upload
    #       command: ${CIRCLE_WORKING_DIRECTORY}/.circleci/upload_to_s3.sh

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
